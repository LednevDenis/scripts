#!/bin/bash
# –ú–∞—Å—Å–æ–≤–∞—è —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª–µ–π –¥–ª—è –í–°–ï–• –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ —Å–∞–π—Ç–æ–≤

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã (UID >= 1000)
echo "üîç –°–∫–∞–Ω–∏—Ä—É—é —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."

getent passwd | awk -F: '$3>=1000 && $3<65534 {print $1}' | grep -v "nobody" > /root/all_users.txt

# –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ
/usr/local/mgr5/sbin/mgrctl -m ispmgr ftp.user | grep "name=" | sed 's/.*name=\([^ ]*\).*/\1/' >> /root/all_users.txt
sort -u /root/all_users.txt -o /root/all_users.txt

echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: $(wc -l < /root/all_users.txt)"
echo "============================================"

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –ø–∞—Ä–æ–ª–µ–π —Å –¥–∞—Ç–æ–π
PASS_FILE="/root/ftp_passwords_$(date +%Y%m%d).txt"
> $PASS_FILE

for user in `cat /root/all_users.txt`
do
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å
    pw=$(pwgen -s 16 1)
    
    echo "üîÑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø–∞—Ä–æ–ª—å –¥–ª—è: $user"
    
    # –ü—ã—Ç–∞–µ–º—Å—è —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å FTP
    /usr/local/mgr5/sbin/mgrctl -m ispmgr ftp.user.edit elid=$user owner=$user passwd=$pw confirm=$pw sok=ok > /dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        echo "   ‚úÖ FTP-–ø–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω"
        echo "$user  $pw" >> $PASS_FILE
    else
        echo "   ‚ö†Ô∏è  FTP-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $user –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é"
    fi
    
    # –ó–∞–æ–¥–Ω–æ –º–µ–Ω—è–µ–º –ø–∞—Ä–æ–ª—å —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    # echo "$user:$pw" | chpasswd
    # echo "   ‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω"
    
    echo ""
done

echo "============================================"
echo "üéâ –†–ê–ë–û–¢–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "üìÅ –ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏: $PASS_FILE"
echo "üìä –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: $(wc -l < $PASS_FILE)"
